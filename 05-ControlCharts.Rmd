# Control charts {#controlcharts}

## Statistical distributions

The primary distinction between run and control charts is that the latter uses parametric statistics to increase the number of properties of a data-defined process that you can monitor. If a particular statistical distribution---such as normal, binomial, or Poisson---match the process you wish to measure, you gain a great deal more power to find insights and monitor change than with a line or run chart. 

### Common distributions and their ranges

Table here.  

### Mean and variance

Variance is mean.  

### What happens when you get the mean-variance relationship wrong

Although control charts can sometimes work when you misspecify the mean-variance relationship (they are "robust" to some assumption violations), you won't know unless you explore the differences in implications between the data as-is and that same data transformed to become more in line with the appropriate or expected distribution. 

For example, if you use the usual normal distribution control limits an *I* chart on exponentially-distributed data, you get something like this:

```{r skewy, fig.height=3.5}
# Create some fake exponentially-distributed process data
set.seed(290)
df2 = data.frame(x = seq(1:120), y = 17+rexp(120))

# Create plot object
exp_nat_var_cc_plot = ggplot(df2, aes(x, y)) + 
  ylim(14.75, 24.75) +
  geom_hline(aes(yintercept=17.88), color="gray", size=1) +
  geom_hline(aes(yintercept=20.87), color="red") +
  geom_hline(aes(yintercept=14.88), color="red") +
  geom_ribbon(aes(ymin = 18.87, ymax = 19.87), alpha = 0.2) +
  geom_ribbon(aes(ymin = 15.88, ymax = 16.88), alpha = 0.2) +
  xlab("Subgroup") + 
  ylab("Value") +
  geom_line() + 
  theme_bw()

# Marginal plot
ggMarginal(exp_nat_var_cc_plot, margins="y", type = "histogram", binwidth=0.25)
```

Clearly something is weird when no points even go below 1 standard deviation. But more importantly, do the points above the upper control limit represent *real* anomalous data points, or are they the result of an improper mean-variance relationship? 

Using a Box-Cox transformation to make the distribution more symmetrical, we can see that those seemingly out-of-control points are actually well within both control limits, and the variation we see is more in line with (statistical) expectation. 

```{r unskewy, fig.height=3.5}
# Box-Cox tansformation 
bob = data.frame(MASS::boxcox(df2$y ~ 1, lambda=seq(-20, 5, 0.5), plotit=F))
bobmax = bob[which.max(bob[,2]),1]

# Adjustment to make plotting cleaner
df2$y2 = (df2$y ^ bobmax) * 10^19

# Create plot object
exp_xform_nat_var_cc_plot = ggplot(df2, aes(x, y2)) + 
  ylim(-0.06, 0.31) +
  geom_hline(aes(yintercept=0.128), color="gray", size=1) +
  geom_hline(aes(yintercept=0.302), color="red") +
  geom_hline(aes(yintercept=-0.046), color="red") +
  geom_ribbon(aes(ymin = 0.186, ymax = 0.244), alpha = 0.2) +
  geom_ribbon(aes(ymin = 0.012, ymax = 0.070), alpha = 0.2) +
  xlab("Subgroup") + 
  ylab("Transformed Value") +
  geom_line() + 
  theme_bw()

# Marginal plot
ggMarginal(exp_xform_nat_var_cc_plot, margins="y", type = "histogram", binwidth=0.025)
```

The main drawback is that you now have a chart of essentially uninterptable values---but that's better than assuming a normal distribution will be just fine and being unnecessarily alarmed by false positive signals, wasting time and resources searching for a special cause that doesn't exist.    


## Which control chart should I use? {#whichcontrolchart}

The following flow chart can help you determine which kind of control chart you might want to use. More details and formulas for each control chart type are provided in the next few chapters.   

![](images/control_chart_flowchart.png)

