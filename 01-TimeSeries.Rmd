# Where to start

*Portions of this chapter are adapted from [@barry2016].*   

## R libraries

```{r loadpackages, message=FALSE, warning=FALSE, echo=TRUE}
library(ggplot2)   # for plotting
library(lubridate) # for easier date/time casting
library(forecast)  # for seasonplots and forecasts
library(qicharts)  # for simple run and control charts
library(ggseas)    # for seasonal plotting
```

## Start with a line chart and a histogram

**Before anything else**, plot your data as...  

...a line chart...

```{r plot_it_first_line, echo=TRUE}
# Create data
set.seed(250)
df = data.frame(x = seq(as.Date("2006-01-01"), by = "month", length.out = 120),
                y = 18 + rnorm(120))

# Line plot
ggplot(df, aes(x, y)) + 
  geom_line()
```

...and as a histogram that includes a density overlay for a more "objective" sense of the distribution.

```{r plot_it_first_hist, echo=TRUE}
# Histogram with density overlay
ggplot(df, aes(y)) + 
  geom_histogram(aes(y = ..density..), binwidth = 0.5) +
  geom_density(color="blue")
```

In these plots, consider:  

- The shape of the distribution: symmetrical/skewed, uniform/peaked, whether changes in binwidth show patterning, etc.  
- Whether you see any trending, cycles, or suggestions of autocorrelation.  
- Whether there are any obvious outliers or inliers.  

|  |  


![](images/tipicon.png)  **Understanding your data at this stage is a fundamental prerequisite of SPC work.**


## Then do exploratory time-series analysis

Create a time series (`ts`) object from your data:

```{r make_ts, echo=TRUE}
df_ts = ts(df$y, start = c(2006,01), frequency = 12)
```

With that, you can create a variety of exploratory and diagnotic plots that help you understand the data more thoroughly.  

### Seasonplot
```{r seasonplot, echo=TRUE}
ggseasonplot(df_ts)
```

### Monthplot
```{r monthplot, echo=TRUE}
ggmonthplot(df_ts)
```

### Autocorrelation
```{r acf, echo=TRUE}
autoplot(acf(df_ts, plot = FALSE))
```

### Cycles
```{r periodicity, echo = TRUE}
TSA::periodogram(df_ts)
```

### Decomposition
```{r decomp, echo=TRUE}
autoplot(decompose(df_ts))
```

### Overall trend (if any)
```{r loess_trend, echo=TRUE}
autoplot(df_ts) + 
  geom_smooth()
```

### Seasonal adjustment
```{r seasonal, echo=TRUE}
# Convert ts to data frame
df_ts_df = tsdf(df_ts)

# Plot original qnd seasonally adjusted data
ggplot(df_ts_df, aes(x, y)) + 
  geom_line(color="gray70") +
  stat_seas(color="darkblue")
```

### Residuals 
```{r residuals, echo=TRUE}
# Convert ts residuals to data frame
df_ts_df_rand = tsdf(decompose(df_ts)$random)

# Add month as a factor
df_ts_df_rand$mnth = factor(rep(month.abb, 10), levels = month.abb)

# Plot residuals
# No apparent patterns
ggplot(df_ts_df_rand, aes(x, y)) + 
  geom_hline(yintercept=0, linetype="dotted") +
  geom_smooth(color = "gray70", alpha = 0.2) +
  geom_point(aes(color = mnth)) 

# Residuals faceted by month
# Is December weird? Rest seem ok
ggplot(df_ts_df_rand, aes(x, y)) + 
  geom_hline(yintercept=0, linetype="dotted") +
  geom_smooth(color = "gray70", alpha = 0.2) +
  facet_wrap(~ mnth) +
  geom_point(aes(color = mnth)) 

```


### What does it look like when there are time-dependent patterns?

```{r patterns, echo=TRUE}
# Use Australian beer data
data(ausbeer, package="fpp")
beer = window(ausbeer, start=1992)

# Summary plots
ggtsdisplay(beer, plot.type="spectrum")

# Seasonplot
ggseasonplot(beer)

# Monthplot
ggmonthplot(beer)

# Convert ts to data frame
df_ts_df_rand = tsdf(decompose(beer)$random)
df_ts_df_rand$qtr = factor(quarter(date_decimal(df_ts_df_rand$x)))

# All together residuals
ggplot(df_ts_df_rand, aes(x, y)) + 
  geom_hline(yintercept=0, linetype="dotted") +
  geom_smooth(color = "gray70", alpha = 0.2) +
  geom_point(aes(color = qtr)) +
  scale_color_manual(values=c("#E69F00", "#56B4E9", "#009E73", "#000000"))

# Residuals faceted by quarter
ggplot(df_ts_df_rand, aes(x, y)) + 
  geom_hline(yintercept=0, linetype="dotted") +
  geom_smooth(color = "gray70", alpha = 0.2) +
  facet_wrap(~ qtr) +
  geom_point(aes(color = qtr)) +
  scale_color_manual(values=c("#E69F00", "#56B4E9", "#009E73", "#000000"))
```
